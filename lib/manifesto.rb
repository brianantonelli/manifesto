require 'digest/md5'
require 'find'

# Manifesto.cache(:directory => '/public', :checksum => false)

module Manifesto
  def self.cache(options = {})
    directory = options.fetch(:directory, './public')
    checksum  = options.fetch(:checksum, true)
    raise(ArgumentError, ":directory must be a directory") unless valid_directory?(directory)
    raise(ArgumentError, ":checksum must be a boolean") unless valid_checksum?(checksum)
    
    # raise an ArgumentError if :directory is not a file path
    # raise an ArgumentError if :checksum is not a boolean
    manifest = []
    hashes = ''
    Find.find(directory) do |file|
    
      # Only include real files (i.e. not directories, symlinks etc.) and non-hidden
      # files in the manifest.
      if File.file?(file) && File.basename(file)[0,1] != '.'
        manifest << "#{file}\n"
      
        # Read the file contents to calculate the MD5 hash, so that if a file is
        # changed, the manifest is changed too.
        if checksum
          digest = Digest::MD5.new
          File.open(file, 'r') do |f|
            digest.update(f.read(8192)) until f.eof
            hashes += digest.hexdigest
          end
        end
      end
    end
    
    # Hash the hashes of each file and output as a comment.
    manifest << "# Checksum: #{Digest::MD5.hexdigest(hashes)}\n" if checksum
    manifest << "# Generated by manifesto (http://github.com/johntopley/manifesto)"
    manifest << "CACHE MANIFEST\n"
    manifest.reverse
  end
  
  private
  def self.valid_checksum?(checksum)
    checksum.is_a?(TrueClass) || checksum.is_a?(FalseClass)
  end
  
  def self.valid_directory?(directory)
    true
  end
end